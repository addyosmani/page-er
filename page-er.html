<link rel="import" href="../polymer/polymer.html">

<!--
Element paginates arbitrary model data. It renders a set of pagination controls for navigating through a collection of data.

##### Example

    <page-er perpage="5"></page-er>

    <page-er perpage="10" currentpage="3"></page-er>

    <page-er next="Next >" previous="< Previous "></page-er>

@element page-er
@blurb Element paginates arbitrary model data
@status alpha
@homepage http://addyosmani.github.io/page-er
-->
<polymer-element name="page-er" attributes="perpage currentpage next previous rangeSize data customTemplate">
  <template>
    <template ref="itemTemplate" id="template" bind="{{scope}}">
        <!-- Filled with light DOM content if customTemplate is true -->
    </template>
    <link rel="stylesheet" href="page-er.css">
    <div class="pagination">
      <!-- By default, if no customTemplate is supplied use our own -->
        <template if="{{!customTemplate}}" id="template">
          <ul>
            <li><button on-click="{{firstPage}}">First</button></li>
            <li class='{{currentpage === 0 ? "disabled" : ""}}'>
              <button on-click="{{prevPage}}">{{previous}}</button>
            </li>
            <template repeat="{{n in currentRange}}">
              <li class="{{n == currentpage ? 'active' : ''}}" data-item="{{n}}" on-click="{{setPage}}">
                <button>{{n+1}}</button>
              </li>
            </template>
            <li class='{{currentpage === pageCount? "disabled" : ""}}'>
              <button on-click="{{nextPage}}">{{next}}</button>
            </li>
            <li><button on-click="{{lastPage}}">Last</button></li>
          </ul>
      </template>
      </div>
  </template>
  <script>
  Polymer('page-er', {
    /**
     * The `perpage` attribute defines the number
     * of items to show per page
     *
     * @attribute perpage
     * @type number
     */
    perpage: 10,
    /**
     * The `currentpage` attribute specifies the
     * current active page in view
     *
     * @attribute currentpage
     * @type number
     */
    currentpage: 0,
    /**
     * The `currentRange` property specifies the
     * range of pages (e.g 1, 2, 3, 4, 5) to display
     *
     * @property currentRange
     * @type array
     */
    currentRange: [],
    customTemplate: false,
    /**
     * The `pageCount` specifies the number of paginated pages
     *
     * @property pageCount
     * @type number
     */
    pageCount: 0,
    /**
     * The `rangeSize` attribute specifies the total size * of the paginated range of items
     *
     * @attribute rangeSize
     * @type number
     */
    rangeSize: 10,
    /**
     * The `items` property is the cached instance of the model data for pagination
     *
     * @property items
     * @type array
     */
    items: [],
    /**
     * The `data` attribute is the complete set of data we
     * wish to be paginated
     *
     * @attribute data
     * @type array
     */
    data: [],
    /**
     * The `previous` attribute specifies the label
     * for the Previous button
     *
     * @attribute previous
     * @type string
     */
    previous: "<< Prev",
    /**
     * The `next` attribute specifies the label
     * for the Next button
     *
     * @attribute next
     * @type string
     */
    next: "Next >>",

    dataChanged: function(){

      // this.data is the complete original set of data

      // Update current range to account for items per page, range.
      this.currentRange = this.range();

      // Cache the total page count
      this.pageCount =  this.getPageCount();

      // Update model bound to UI with filtered range
      // Source of truth for the component
      this.items = this.filterPage();

      // Fire event for once model data is paged
      this.fire('pager-data', { data: this.items });
    },

    /**
     * Navigate to the first page
     *
     * @method firstPage
     */
    firstPage: function () {
      this.currentpage = 0;
    },

    /**
     * Navigate to the last page
     *
     * @method lastPage
     */
    lastPage: function () {
      this.currentpage = this.pageCount;
    },

    /**
     * Called when navigating to the previous page
     *
     * @param {Object} page
     * @event pager-previous
     */

    /**
     * Navigate to the previous page
     *
     * @method prevPage
     */
    prevPage: function () {
      if ( this.currentpage > 0 ) {
        this.currentpage--;
        this.fire('pager-previous', { page: this.currentpage });
      }
    },

    /**
     * Called when navigating to the next page
     *
     * @param {Object} page
     * @event pager-next
     */

    /**
     * Navigate to the next page
     *
     * @method nextPage
     */
    nextPage: function () {
      if ( this.currentpage < this.getPageCount() ) {
        this.currentpage++;
        this.fire('pager-next', { page: this.currentpage });
      }
    },

    /**
     * Updates the current page if the page is in bound
     *
     * @param {string} page
     * @method changePage
     */
    changePage: function (page) {
      var desiredPage = parseInt(page, 10);
      if (desiredPage <= this.getPageCount()) {
        this.currentpage = desiredPage;
      }
    },

    prevPageDisabled: function () {
      return this.currentpage === 0 ? "disabled" : "";
    },

    nextPageDisabled: function() {
      return this.currentpage === this.getPageCount() ? "disabled" : "";
    },

    getPageCount: function () {
      return Math.ceil( this.data.length / this.perpage ) - 1;
    },

    setPage: function (e,d,t) {
      this.currentpage = parseInt( t.dataset.item, 10 );
    },

    /**
     * Called when the current page changes
     *
     * @param {Object} page
     * @event pager-change
     */
    currentpageChanged: function () {
      this.items = this.filterPage();
      this.currentRange = this.range();
      this.fire('pager-change', { page: this.currentpage, data: this.items });
    },

    perpageChanged: function () {
      this.currentpageChanged();
    },

    range: function () {
      var paginations = [];
      var start = this.currentpage;

      if ( start > this.getPageCount() - this.rangeSize ) {
        start = this.getPageCount() - this.rangeSize + 1;
      }

      for ( var i = 0; i < start + this.rangeSize; i++ ) {
        paginations.push(i);
      }

      return paginations;
    },

    filterPage: function () {
      return this.data.slice(this.currentpage * this.perpage, (this.currentpage * this.perpage) + this.perpage);
    },

    ready: function () {
      if (this.customTemplate) {
        /* The custom layout for your pagination controls will likely
           use templates, which we will need to re-bind to data within
           the scope of this element. The .scope hack below gives us
           a reference to the element scope that we can bind to, populating
           your supplied template accordingly. We will update this if we
           find a better way to handle it.*/
        this.scope = this;
        var tmpl = document.createElement('template');
        tmpl.id = "itemTemplate";
        tmpl.innerHTML = this.innerHTML;
        this.shadowRoot.appendChild(tmpl);
      }
    }
  });
  </script>
</polymer-element>
